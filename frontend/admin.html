<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Menu - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
<header class="bg-blue-600 text-white p-4 shadow-lg flex justify-between items-center">
    <h1 class="text-2xl font-bold">Smart E-Menu Admin</h1>
    <button onclick="openModal()" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-bold hover:bg-gray-100 transition">
        + Add New Dish
    </button>
</header>

<main class="p-6">
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <table class="min-w-full">
            <thead class="bg-gray-50 border-b">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dish</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Price</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
            </thead>
            <tbody id="dishTableBody" class="divide-y divide-gray-200">
            </tbody>
        </table>
    </div>
</main>

<div id="dishModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
        <h2 class="text-xl font-bold mb-4 text-center">Add New Item</h2>
        <form id="dishForm" class="space-y-3">
            <input type="text" id="name" placeholder="Name (e.g. Ghavne)" class="w-full p-2 border rounded" required>
            <textarea id="description" placeholder="Short Description" class="w-full p-2 border rounded"></textarea>
            <input type="number" step="0.01" id="price" placeholder="Price (₹)" class="w-full p-2 border rounded" required>
            <input type="text" id="imageUrl" placeholder="Image URL (Unsplash)" class="w-full p-2 border rounded">
            <input type="number" id="categoryId" placeholder="Category ID (Try 1)" class="w-full p-2 border rounded" required>

            <div class="flex items-center gap-2 py-2">
                <input type="checkbox" id="isVeg" class="w-4 h-4">
                <label for="isVeg" class="text-sm font-medium">Vegetarian?</label>
            </div>

            <div class="flex gap-2 pt-2">
                <button type="button" onclick="closeModal()" class="flex-1 py-2 bg-gray-200 rounded-lg">Cancel</button>
                <button type="submit" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold">Save Dish</button>
            </div>
        </form>
    </div>
</div>

<script>
    const API_URL = 'http://localhost:8080/api/dishes';

    // 1. FETCH AND SHOW DISHES
    async function loadDishes() {
        try {
            console.log("Fetching dishes...");
            const res = await fetch(API_URL);
            if (!res.ok) throw new Error("Failed to connect to Backend");

            const dishes = await res.json();
            const tableBody = document.getElementById('dishTableBody');

            tableBody.innerHTML = dishes.map(dish => `
            <tr class="border-b hover:bg-gray-50">
                <td class="px-6 py-4 flex items-center gap-3">
                    <img src="${dish.imageUrl || 'https://via.placeholder.com/50'}" class="w-10 h-10 rounded-full object-cover">
                    <span class="font-bold">${dish.name}</span>
                </td>
                <td class="px-6 py-4">${dish.category ? dish.category.name : 'Uncategorized'}</td>
                <td class="px-6 py-4 font-bold text-blue-600">₹${dish.price}</td>
                <td class="px-6 py-4 text-center">
                    <button onclick="deleteDish(${dish.id})" class="text-red-500 font-bold">Delete</button>
                </td>
            </tr>
        `).join('');
        } catch (err) {
            console.error("Error loading dishes:", err);
            alert("Cannot load dishes. Is your Spring Boot app running?");
        }
    }

    // 2. SAVE A NEW DISH
    document.getElementById('dishForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        // Create the "JSON Package" to send to Java
        const payload = {
            name: document.getElementById('name').value,
            description: document.getElementById('description').value,
            price: parseFloat(document.getElementById('price').value),
            imageUrl: document.getElementById('imageUrl').value,
            veg: document.getElementById('isVeg').checked, // Matches Java 'veg'
            available: true,                               // Matches Java 'available'
            category: { id: parseInt(document.getElementById('categoryId').value) }
        };

        console.log("Sending payload:", payload);

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                alert("Success! Dish saved to database.");
                closeModal();
                loadDishes(); // Refresh the list immediately!
            } else {
                const errorData = await response.text();
                alert("Error: " + errorData);
            }
        } catch (err) {
            alert("Network Error: Check your Spring Boot console.");
        }
    });

    // 3. DELETE A DISH
    async function deleteDish(id) {
        if (confirm("Delete this dish forever?")) {
            await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
            loadDishes();
        }
    }

    function openModal() { document.getElementById('dishModal').classList.remove('hidden'); }
    function closeModal() { document.getElementById('dishModal').classList.add('hidden'); }

    // Run this when the page opens
    window.onload = loadDishes;
</script>